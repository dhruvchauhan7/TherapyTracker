<h2 style="margin:0 0 12px 0;">Clients</h2>
<p *ngIf="error" class="error">❌ {{ error }}</p>

<div class="toolbar">
  <button class="btn" *ngIf="isAdmin" (click)="openCreate()">+ New Client</button>
</div>

<div class="card-table">
  <table>
    <thead>
      <tr>
        <th style="width:50%">Name</th>
        <th>Clinician</th>
        <th *ngIf="isAdmin" style="width:1px">Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngIf="loading">
        <td colspan="3">Loading…</td>
      </tr>

      <tr *ngIf="!loading && clients.length === 0">
        <td colspan="3" class="muted">No clients yet.</td>
      </tr>

      <tr *ngFor="let c of clients">
        <td>{{ c.name }}</td>
        <td>{{ nameFor(c.assignedClinicianId) }}</td>
        <td *ngIf="isAdmin">
          <button class="link" (click)="openEdit(c)">Edit</button>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Backdrop -->
<div class="overlay" *ngIf="showForm" (click)="cancel()"></div>

<!-- Modal -->
<div class="modal" *ngIf="showForm" role="dialog" aria-modal="true">
  <div class="modal-card" (click)="$event.stopPropagation()">
    <h3>{{ editingId ? 'Edit Client' : 'New Client' }}</h3>

    <div class="modal-body">
      <!-- Client name -->
      <label class="field">
        <span>Name</span>
        <input type="text" [(ngModel)]="form.name" />
      </label>

      <!-- Assigned clinician (Admin only) -->
      <label class="field" *ngIf="isAdmin">
        <span>Assigned Clinician</span>

        <div class="combo" #comboRef>
          <input #clinicianInput
                 type="text"
                 placeholder="Search clinician…"
                 [(ngModel)]="clinicianSearch"
                 (focus)="showClinicianMenu = true"
                 (input)="showClinicianMenu = true"
                 (keydown.enter)="selectFirstMatch($event)"
                 (keydown.escape)="showClinicianMenu = false" />

          <ul class="menu" *ngIf="showClinicianMenu">
            <li *ngFor="let cl of filteredClinicians()"
                (click)="selectClinician(cl, clinicianInput)">
              <strong>{{ cl.name }}</strong>
              <small>{{ cl.email }}</small>
            </li>
            <li *ngIf="filteredClinicians().length === 0" class="muted">No matches</li>
          </ul>
        </div>
      </label>
    </div>

    <div class="modal-actions">
      <button class="btn" (click)="save()">Save</button>
      <button class="btn btn-ghost" (click)="cancel()">Cancel</button>
    </div>
  </div>
</div>
